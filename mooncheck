#!/bin/bash


[ ! "${1}" ] && echo "Usage: mooncheck <filename.moon> [<luacheck-arguments]" && exit 1

set -ex

target=${1}
target_regexfix=${target//\//\\\/}
opt=${*#${target}}

moonc_tmp=$(mktemp)
lc_tmp=$(mktemp)
format_tmp=$(mktemp)
mooncX_tmp=$(mktemp)

trap 'rm ${moonc_tmp} ${lc_tmp} ${format_tmp} ${mooncX_tmp} > /dev/null 2>&1' 0 1 2 3 15


# Syntax error
if ! moonc -p "${target}" > "${moonc_tmp}" 2>&1; then
	awk 'NR==2' "${moonc_tmp}" | perl -pe "s/^\D*(\d+).*?>>\s+(.*)$/E: ${target_regexfix}:\1: Failed to parse/"
	exit 1
fi

# check lua file parsed
luacheck ${opt} --formatter plain --no-color "${moonc_tmp}" > "${lc_tmp}" || :

perl -pe "s/^.*?:(\d+):.*?\s+(.*)$/\1 \2/" < "${lc_tmp}" > "${format_tmp}"

# compare the line of lua file parsed and target moon file
moonc -X "${target}" > "${mooncX_tmp}" 2> /dev/null


# refer luacheck'error line to target moon file
while read l; do
	warn=$(echo "${l}" | perl -pe "s/^\d+\s//")
	arg=$(echo "${l}" | perl -pe "s/^(\d+).*$/^\\\\d+\\\\s+\1:/")
	ag --nocolor --nonumbers  "${arg}" "${mooncX_tmp}" | perl -pe "s/^\d+.+?\s\]\s>>\s(\d+):.*$/W: ${target_regexfix}:\1: ${warn}/"
done < "${format_tmp}"

